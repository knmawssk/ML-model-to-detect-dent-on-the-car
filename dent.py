# -*- coding: utf-8 -*-
"""dent

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/102iv7mBAab6KYrRBvTf_TbhFq7Huvkej
"""

!pip install ultralytics roboflow albumentations tqdm pyyaml

!pip install roboflow

from roboflow import Roboflow
rf = Roboflow(api_key="")
project = rf.workspace("fall-on7ds").project("dent-car-xpswt")
version = project.version(2)
dataset = version.download("yolov8", location='dentcardataset')

!mv //content/dentcardataset/valid /content/dentcardataset/val

!python /content/pipeline.py \
  --mode full \
  --data-source local \
  --dataset-dir /content/dentcardataset \
  --augmented-dir /content/dentcardatasetRESULT \
  --num-aug 2 \
  --model-path yolov8s.pt \
  --epochs 10 \
  --batch-size 4 \
  --class-names damage \
  --device 0

!pip install ultralytics opencv-python

from ultralytics import YOLO
from collections import Counter
from IPython.display import Image, display
import cv2
import os

# Load your trained model
model = YOLO('/content/results/train/weights/best.pt')

# Path to an image you want to test
image_path = '/content/Ð¡Ð½Ð¸Ð¼Ð¾Ðº ÑÐºÑ€Ð°Ð½Ð° 2025-09-14 Ð² 14.49.35.png'  # replace with real image path

# Run prediction
results = model.predict(source=image_path, conf=0.3)

# Get detected class indices
classes = results[0].boxes.cls.tolist()
counts = Counter(classes)

# Class indices based on dataset.yaml
damage_count = counts.get(0, 0)

# --- Draw bounding boxes ---
img = cv2.imread(image_path)

for box, cls in zip(results[0].boxes.xyxy, results[0].boxes.cls):
    x1, y1, x2, y2 = map(int, box)
    if int(cls) == 0:
        color = (0, 0, 255)  # ÐºÑ€Ð°ÑÐ½Ñ‹Ð¹
        label = "damage"
    else:
        continue
    cv2.rectangle(img, (x1, y1), (x2, y2), color, 2)
    cv2.putText(img, label, (x1, y1 - 5),
                cv2.FONT_HERSHEY_SIMPLEX, 0.6, color, 2)

# Save and show image
cv2.imwrite("predicted_people.jpg", img)
display(Image(filename="predicted_people.jpg"))

# Decide based on detection
if damage_count > 0:
    print("The car has damage!")
else:
    print("The car does not have damage")

!pip install ultralytics opencv-python

from ultralytics import YOLO
from collections import Counter
from IPython.display import Image, display
import cv2
import os

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
model = YOLO('/content/results/train/weights/best.pt')

# ÐŸÐ°Ð¿ÐºÐ° Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸ (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ JPG/PNG)
image_folder = '/content/dent-or-clean-1/test/images'

# ÐŸÐ°Ð¿ÐºÐ° Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
output_folder = '/content/damagedcarsonlyresults'
os.makedirs(output_folder, exist_ok=True)

# Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð´Ð»Ñ Ð¿Ð¾ÐºÐ°Ð·Ð° Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð¾Ð²
saved_images = []

# ÐŸÑ€Ð¾Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾ Ð²ÑÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼
for filename in os.listdir(image_folder):
    if filename.lower().endswith(('.jpg', '.jpeg', '.png')):
        image_path = os.path.join(image_folder, filename)
        results = model.predict(source=image_path, conf=0.3, verbose=False)

        # ÐŸÐ¾Ð´ÑÑ‡Ñ‘Ñ‚ ÐºÐ»Ð°ÑÑÐ¾Ð²
        classes = results[0].boxes.cls.tolist()
        counts = Counter(classes)

        damage_count = counts.get(0, 0)

        # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
        img = cv2.imread(image_path)

        # Ð Ð¸ÑÑƒÐµÐ¼ Ð±Ð¾ÐºÑÑ‹
        for box, cls in zip(results[0].boxes.xyxy, results[0].boxes.cls):
            x1, y1, x2, y2 = map(int, box)
            if int(cls) == 0:  # damage
                color = (0, 0, 255)
                label = "damage"
            else:
                continue

            cv2.rectangle(img, (x1, y1), (x2, y2), color, 2)
            cv2.putText(img, label, (x1, y1 - 5),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.6, color, 2)

        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ
        save_path = os.path.join(output_folder, filename)
        cv2.imwrite(save_path, img)

        # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        if damage_count > 0:
            print(f"{filename}: ðŸš¨ The car is DAMAGED!")
        else:
            print(f"{filename}: âœ… The car is CLEAN")

        saved_images.append(save_path)

# ÐŸÐ¾ÐºÐ°Ð¶ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3 ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ Ð² Ð½Ð¾ÑƒÑ‚Ð±ÑƒÐºÐµ
for img_path in saved_images[:3]:
    display(Image(filename=img_path))

from ultralytics import YOLO
import pandas as pd
import os
model = YOLO('/content/results/train2/weights/best.pt')
metrics = model.val(split='val')

# Print the metrics
print("Evaluation Metrics:")
print(f"  Precision: {metrics.box.mp}")
print(f"  Recall: {metrics.box.mr}")
print(f"  mAP50: {metrics.box.map50}")
print(f"  mAP50-95: {metrics.box.map}")

!zip -r /content/damagedcarsonlyresults.zip /content/damagedcarsonlyresults

